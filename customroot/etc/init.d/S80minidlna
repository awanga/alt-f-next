#!/bin/sh -e

NAME=minidlna
DESC="MiniDLNA is a DLNA/UPnP-AV server."
TYPE=user

PIDFILE=/var/run/$NAME.pid
CONFF=/etc/$NAME.conf
MINIDLNA_USER=$NAME
MINIDLNA_GROUP=multimedia
#MINIDLNA_ARGS="-d -P $PIDFILE"
MINIDLNA_ARGS=""

check_shares() {
	if test -r "$CONFF"; then
		MDLNA_DIR="$(awk -F= '/^media_dir/{printf "%s;", $2}' $CONFF)"
		OIFS="$IFS"; IFS=";"
		for i in $MDLNA_DIR; do
			#eval "$i"
			if test ! -d "$i"; then
				echo "Share $i does not exist."
				exit 1
			else
				conf_ok=1
			fi
		done
		IFS="$OIFS"
		if test -z "$conf_ok"; then
			echo "No shares configured."
			exit 1
		fi
		return 0
	fi
	echo "Configuration file does not exist."
	exit 1
}

case "$1" in

	start)
		echo -n "Starting $NAME: "
		check_shares

		#touch $PIDFILE
		#chown $MINIDLNA_USER:$MINIDLNA_GROUP $PIDFILE
		start-stop-daemon --start --quiet --background --oknodo \
			--chuid $MINIDLNA_USER:$MINIDLNA_GROUP \
			--exec $NAME -- $MINIDLNA_ARGS
		if test $? = 1; then
			echo "Fail."
			exit 1
		fi
		echo "OK."
		exit 0
		;;

	stop)
		echo -n "Stopping $NAME: "
		# it should do a clean shutdown on SIGTERM or SIGINT, but hangs
		start-stop-daemon --stop --quiet --oknodo --signal 1 --exec $NAME
		if test $? = 1; then
			echo "Fail."
			exit 1
		fi
		echo "OK"
		exit 0	
		;;

	status)
		if start-stop-daemon -K -t -q -n $NAME; then
			echo "$NAME running"
			exit 0
		else
			echo "$NAME stopped"
			exit 1
		fi
		;;

	restart|force-reload)
		sh $0 stop
		while start-stop-daemon -K -t -q -n $NAME; do usleep 200000; done
		sh $0 start
		;;

	*)
		echo "Usage: $0 {start|stop|status|restart|force-reload}"
		exit 1
		;;
esac
